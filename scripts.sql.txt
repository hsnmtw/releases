delete from [etc_group] where [Id] in (158,157);
delete from [etc_usergroup] where [id]=4515;
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2427781428');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1089183402');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1070412810');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1065894477');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1061706493');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1064916149');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1065779025');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1037180591');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1063264160');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1091677821');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1070703317');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1102470315');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1067415578');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1037852025');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1041232990');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1066345537');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1074442938');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1061267421');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1074216910');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2501219949');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2557627649');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2375135668');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2382017263');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2485173401');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1068812997');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1105674285');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2501219212');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1014894800');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1011541578');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1026876175');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1051808135');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1081820159');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1045730841');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1088826191');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1071160970');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2493811703');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2376285967');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2561757044');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2423905187');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2230572246');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2539140349');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2336059502');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1040260505');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2408130157');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1060321179');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2285292500');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1055823387');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1031447863');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1020436604');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1039287527');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2337714618');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1060397898');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2364460853');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2491504151');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1088437080');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1067295541');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1090820992');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1034782100');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1055394553');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2446958569');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1063688046');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1007865395');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1084570777');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2410282988');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1066942648');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1040564294');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2388765782');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2366820633');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1042782811');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1095625909');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1006373847');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1094229430');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1095392401');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1016860163');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1059195097');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1087626519');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1065180950');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1050783073');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2501822627');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2336060146');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1055003238');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1066320720');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1083338531');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1045447354');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1028391504');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1080852484');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1016949669');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1057729079');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1080193772');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1105560054');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1065634063');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1093812558');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1080768433');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1061912315');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1078415468');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1067619211');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1123407130');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1092088994');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1098854076');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1059189850');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1016122135');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1128965397');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2416470710');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1076324647');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2458389646');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2367846884');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1075941466');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2271861250');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1051675716');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2016008571');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1069056099');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1059673440');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1082172436');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1037481486');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1039482920');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1003163134');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2416290647');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1101502100');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1095824627');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1081164525');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2187162256');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1070475171');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1000248532');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1069311718');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2008738953');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1074461888');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2453108710');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1087404164');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1067181634');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1069407169');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2466361090');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1047924533');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2476752668');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1035842861');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1052317862');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2365236443');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1060996434');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1075132520');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('2196183756');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1121620551');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1127460929');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1202249452');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1110651310');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('0500437083');
update common_user set isenabled=1,updatedby='auto',updatedon=getdate() where nationalid in ('1104755167');
update common_user set isenabled=0 where updatedby != 'auto';

ALTER TABLE etc_user ADD [Email] varchar(100) default '!';

DROP table [etc_User_old];
DROP table [etc_Group_old];
DROP table [etc_UserGroup_old];
DROP table [etc_UserPasswordCache_old];


ALTER TABLE [etc_User] RENAME TO [etc_User_old];
ALTER TABLE [etc_Group] RENAME TO [etc_Group_old];
ALTER TABLE [etc_UserGroup] RENAME TO [etc_UserGroup_old];
ALTER TABLE [etc_UserPasswordCache] RENAME TO [etc_UserPasswordCache_old];


CREATE TABLE [etc_group] (
   [Id] Integer NOT NULL    PRIMARY KEY AUTOINCREMENT,
   [Name] NVARCHAR(255) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [Owner] NVARCHAR(50) COLLATE NOCASE   ,
   [FQDN] NVARCHAR(255) COLLATE NOCASE
 , CONSTRAINT [UK_etc_group_pdb] UNIQUE([Name])
);

CREATE TABLE [etc_usergroup] (
   [Id] Integer NOT NULL    PRIMARY KEY AUTOINCREMENT,
   [GroupName] NVARCHAR(255) COLLATE NOCASE  NOT NULL ,
   [Username] NVARCHAR(255) COLLATE NOCASE NOT NULL
 , CONSTRAINT [UK_etc_usergroup_vdx] UNIQUE([GroupName],[Username])
);

CREATE TABLE [etc_user] (
   [Id] Integer NOT NULL    PRIMARY KEY AUTOINCREMENT,
   [ExpiryDate] DATETIME   ,
   [Username] NVARCHAR(50) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [Manager] NVARCHAR(50) COLLATE NOCASE   ,
   [NameEn] NVARCHAR(200) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [NameAr] NVARCHAR(200) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [Email] NVARCHAR(255) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [GivenNameEn] NVARCHAR(255) COLLATE NOCASE   ,
   [MiddleNameEn] NVARCHAR(255) COLLATE NOCASE   ,
   [ThirdNameEn] NVARCHAR(255) COLLATE NOCASE   ,
   [SurNameEn] NVARCHAR(255) COLLATE NOCASE   ,
   [GivenNameAr] NVARCHAR(255) COLLATE NOCASE   ,
   [MiddleNameAr] NVARCHAR(255) COLLATE NOCASE   ,
   [ThirdNameAr] NVARCHAR(255) COLLATE NOCASE   ,
   [SurNameAr] NVARCHAR(255) COLLATE NOCASE   ,
   [Password] NVARCHAR(100) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [NationalId] NVARCHAR(100) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [Nationality] NVARCHAR(200) COLLATE NOCASE   ,
   [EmployeeId] NVARCHAR(10) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [Mobile] NVARCHAR(20) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [FailedLoginAttempts] Integer NOT NULL DEFAULT 0   ,
   [LastUsed] DATETIME   ,
   [CreatedOn] DATETIME   ,
   [LastPasswordResetOn] DATETIME   ,
   [PasswordExpiry] DATETIME   ,
   [IsEnabled] BIT NOT NULL DEFAULT 0
 , CONSTRAINT [UK_etc_user_hbq] UNIQUE([Username])
);

CREATE TABLE [etc_UserPasswordCache] (
   [Id] Integer NOT NULL    PRIMARY KEY AUTOINCREMENT,
   [Username] NVARCHAR(50) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [Password] NVARCHAR(100) COLLATE NOCASE  NOT NULL  DEFAULT '!' ,
   [CreatedOn] DATETIME NOT NULL DEFAULT '2000-01-01 00:00:00'
);

INSERT INTO [etc_User] ([ExpiryDate],[Username],[Manager],[NameEn],[NameAr],[Email],[GivenNameEn],[MiddleNameEn],[ThirdNameEn],[SurNameEn],[GivenNameAr],[MiddleNameAr],[ThirdNameAr],[SurNameAr],[Password],[NationalId],[Nationality],[EmployeeId],[Mobile],[FailedLoginAttempts],[LastUsed],[CreatedOn],[LastPasswordResetOn],[PasswordExpiry],[IsEnabled]) SELECT [ExpiryDate],[Username],[Manager],case when [NameEn] is null then '?' else [nameen] end,case when [Namear] is null then '?' else [namear] end,[Email],[GivenNameEn],[MiddleNameEn],[ThirdNameEn],[SurNameEn],[GivenNameAr],[MiddleNameAr],[ThirdNameAr],[SurNameAr],[Password],case when [NationalId] is null then [Username] else [NationalId] end,[Nationality],case when [EmployeeId] is null then [Username] else [EmployeeId] end,case when [Mobile] is null then [Username] else [Mobile] end,case when [FailedLoginAttempts] is null then 0 else [FailedLoginAttempts] end,[LastUsed],[CreatedOn],[LastPasswordResetOn],[PasswordExpiry],[IsEnabled] FROM [etc_User_old];
INSERT INTO [etc_Group] ([Name],[Owner],[FQDN]) SELECT [Name],[Owner],(case when [FQDN] is null then [name] else [FQDN] end) FROM [etc_Group_old];
INSERT INTO [etc_UserGroup] ([GroupName],[Username]) SELECT [GroupName],[Username] FROM [etc_UserGroup_old] WHERE [GroupName] is not null and [Username] is not null;
INSERT INTO [etc_UserPasswordCache] ([Username],[Password],[CreatedOn]) SELECT [Username],[Password],[CreatedOn] FROM [etc_UserPasswordCache_old];

ALTER TABLE [common_AutomatedUpgrade] RENAME TO [common_AutomatedUpgrade_old];

CREATE TABLE [common_AutomatedUpgrade] (
   [Id] Integer NOT NULL    PRIMARY KEY AUTOINCREMENT,
   [Secret] NVARCHAR(100) COLLATE NOCASE  NOT NULL  DEFAULT '!'
 , CONSTRAINT [UK_common_AutomatedUpgrade_4mk] UNIQUE([Secret])
);

insert into [common_AutomatedUpgrade] ([Secret]) SELECT [Secret] from [common_AutomatedUpgrade_old];

